<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CBT ë§Œë“¤ê¸° & í’€ê¸° â€” ì¼ìƒë°© 31 (v8 Â· Firebase ë™ê¸°í™”)</title>
<style>
  :root{--gap:12px;--radius:12px}
  body{font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Arial;margin:0;background:#f7f7fb;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .card{background:#fff;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin-top:12px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{display:block;margin:6px 0 4px;font-size:13px;color:#444}
  input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
  textarea{min-height:90px;resize:vertical}
  .btn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.danger{border-color:#b42318;color:#b42318;background:#fff}
  .list{max-height:260px;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px}
  .item{border:1px solid #eee;border-radius:10px;padding:8px;margin-bottom:8px}
  .meta{font-size:12px;color:#666}
  .hidden{display:none !important}
  .choices button{display:block;width:100%;text-align:left;margin-top:8px;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .choices button.correct{border-color:#1a7f37;background:#e9f7ee}
  .choices button.wrong{border-color:#b42318;background:#fdecea}
  .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 0}
  .bar{height:100%;background:#111;width:0}
  .pill{background:#eef0f3;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  .note-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .authbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>CBT ë§Œë“¤ê¸° & í’€ê¸° <span class="pill">ì¼ìƒë°© 31</span></h1>

    <div class="tabs">
      <button class="tab active" id="tabBuild">ë¬¸ì œ ë§Œë“¤ê¸°</button>
      <button class="tab" id="tabQuiz">ë¬¸ì œ í’€ê¸°</button>
      <button class="tab" id="tabReview">ë¦¬ë·°(ì •ë‹µ/ì˜¤ë‹µ ëª¨ì•„ë³´ê¸°)</button>
      <button class="tab" id="tabImport">ëŒ€ëŸ‰ ê°€ì ¸ì˜¤ê¸°</button>
    </div>

    <div class="authbar">
      <span class="pill" id="noteBadge">ì˜¤ë‹µë…¸íŠ¸ 0 Â· ì •ë‹µë…¸íŠ¸ 0</span>
      <span class="meta" id="userInfo">ë¡œê·¸ì¸ í•„ìš”</span>
      <button class="btn" id="btnSignIn">Google ë¡œê·¸ì¸</button>
      <button class="btn" id="btnSignOut" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <!-- ë¹Œë” -->
  <section class="card" id="buildSec">
    <div class="row">
      <div class="col"><label>ê³¼ëª©</label><input id="subject" placeholder="ì˜ˆ: ì§ì—…ìƒë‹´í•™" /></div>
      <div class="col"><label>ë‹¨ì›</label><input id="unit" placeholder="ì˜ˆ: 3ì¥ ì˜ì‚¬ê²°ì •" /></div>
      <div class="col"><label>ì •ë‹µ ë²ˆí˜¸(1~5)</label><input id="answerIndex" type="number" min="1" max="5" value="1" /></div>
    </div>
    <label>ë¬¸ì œ</label>
    <textarea id="question" placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥"></textarea>

    <div class="row">
      <div class="col"><label>ë³´ê¸° 1</label><input id="c1" /></div>
      <div class="col"><label>ë³´ê¸° 2</label><input id="c2" /></div>
      <div class="col"><label>ë³´ê¸° 3</label><input id="c3" /></div>
      <div class="col"><label>ë³´ê¸° 4</label><input id="c4" /></div>
      <div class="col"><label>ë³´ê¸° 5(ì„ íƒ)</label><input id="c5" /></div>
    </div>

    <label>í•´ì„¤(ì„ íƒ)</label>
    <textarea id="explain" placeholder="ì •ë‹µ ê·¼ê±°/ì„¤ëª…"></textarea>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="clearBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
      <button class="btn primary" id="addBtn">ë¬¸ì œ ì¶”ê°€</button>
      <div style="flex:1"></div>
      <input type="file" id="file" class="hidden" accept=".json">
      <button class="btn" id="loadBtn">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" id="saveBtn">JSON ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="startBtn">í€´ì¦ˆ ì‹œì‘</button>
    </div>

    <!-- ë¹Œë”ìš© í•„í„°/ì„ íƒ/ì‚­ì œ -->
    <div class="filter-row" id="buildFilterRow" style="margin-top:12px">
      <label>ê³¼ëª©</label>
      <select id="buildFilterSubject"></select>
      <label>ë‹¨ì›</label>
      <select id="buildFilterUnit"></select>
      <button class="btn" id="buildApplyFilter">í•„í„° ì ìš©</button>
      <button class="btn" id="buildClearFilter">í•„í„° ì´ˆê¸°í™”</button>
      <div style="flex:1"></div>
      <span class="meta">í‘œì‹œ: <span id="buildCount">0</span>ë¬¸í•­</span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="buildSelectAll">ì „ì²´ ì„ íƒ</button>
      <button class="btn" id="buildSelectNone">ì„ íƒ í•´ì œ</button>
      <button class="btn" id="buildSelectInvert">ì„ íƒ ë°˜ì „</button>
      <div style="flex:1"></div>
      <button class="btn danger" id="buildDeleteSelected">ì„ íƒ ì‚­ì œ</button>
    </div>

    <h3 style="margin:14px 0 8px">í˜„ì¬ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸</h3>
    <div class="list" id="listBox"></div>
    <p class="meta">ìë™ ì €ì¥/ë™ê¸°í™”: ë¡œê·¸ì¸ ì‹œ Firestore, ë¯¸ë¡œê·¸ì¸ ì‹œ ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥.</p>
  </section>

  <!-- í€´ì¦ˆ -->
  <section class="card hidden" id="quizSec">
    <div class="filter-row">
      <label>ê³¼ëª©</label>
      <select id="filterSubject"></select>
      <label>ë‹¨ì›</label>
      <select id="filterUnit"></select>
      <button class="btn" id="applyFilter">í•„í„° ì ìš©</button>
      <button class="btn" id="clearFilter">í•„í„° ì´ˆê¸°í™”</button>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="showAll"> í•œë²ˆì— ì „ì²´ ë³´ê¸°</label>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="onlyWrong"> ì˜¤ë‹µë…¸íŠ¸ë§Œ</label>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="onlyCorrect"> ì •ë‹µë…¸íŠ¸ë§Œ</label>
    </div>

    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
      <div class="meta">ë¬¸í•­ <span id="idx">0</span> / <span id="total">0</span></div>
      <div class="meta">ì •ë‹µ <span id="good">0</span> Â· ì˜¤ë‹µ <span id="bad">0</span></div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>

    <p class="meta" id="subjectNow"></p>
    <h2 id="qtext" style="margin:8px 0 6px">ë¬¸ì œë¥¼ ì¶”ê°€í•˜ê³  ì‹œì‘ì„ ëˆŒëŸ¬ì¤˜.</h2>
    <div id="choices" class="choices"></div>
    <p id="exp" class="meta"></p>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="prevBtn">ì´ì „</button>
      <button class="btn" id="backToBuild">ë¬¸ì œ ë§Œë“¤ê¸°ë¡œ</button>
      <div style="flex:1"></div>
      <button class="btn primary" id="nextBtn">ë‹¤ìŒ</button>
    </div>
  </section>

  <!-- ë¦¬ë·° -->
  <section class="card hidden" id="reviewSec">
    <div class="filter-row">
      <label>ê³¼ëª©</label>
      <select id="revSubject"></select>
      <label>ë‹¨ì›</label>
      <select id="revUnit"></select>
      <label>ìƒíƒœ</label>
      <select id="revState">
        <option value="all">ì „ì²´</option>
        <option value="correct">ì •ë‹µ</option>
        <option value="wrong">ì˜¤ë‹µ</option>
      </select>
      <button class="btn" id="revApply">ë³´ê¸°</button>
      <button class="btn" id="exportWrong">ì˜¤ë‹µJSON(ìµœê·¼ìƒíƒœ)</button>
      <button class="btn" id="exportCorrect">ì •ë‹µJSON(ìµœê·¼ìƒíƒœ)</button>
    </div>

    <div class="note-actions">
      <button class="btn" id="exportWrongSet">ì˜¤ë‹µë…¸íŠ¸ JSON(ëˆ„ì )</button>
      <button class="btn" id="exportCorrectSet">ì •ë‹µë…¸íŠ¸ JSON(ëˆ„ì )</button>
      <button class="btn danger" id="clearWrongSet">ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
      <button class="btn danger" id="clearCorrectSet">ì •ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
    </div>

    <div style="margin-top:10px">
      <table>
        <thead><tr><th>#</th><th>ê³¼ëª©</th><th>ë‹¨ì›</th><th>ë¬¸ì œ</th><th>ë‚´ ì„ íƒ</th><th>ì •ë‹µ</th><th>ìƒíƒœ</th></tr></thead>
        <tbody id="revBody"></tbody>
      </table>
    </div>
  </section>

  <!-- ëŒ€ëŸ‰ ê°€ì ¸ì˜¤ê¸° -->
  <section class="card hidden" id="importSec">
    <p class="meta">ì„¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì¤„ ë‹¨ìœ„ë¡œ ë³‘í•©í•´ì„œ ë¬¸ì œë¥¼ ìë™ ìƒì„±í•´ì¤˜.</p>
    <ol>
      <li><b>ë¬¸ì œ íŒŒì¼(.txt/.csv)</b> â€” í•œ ì¤„ì”© <code>ê³¼ëª©|ë‹¨ì›|ë¬¸ì œ|ë³´ê¸°1|ë³´ê¸°2|ë³´ê¸°3|ë³´ê¸°4|ë³´ê¸°5(ì„ íƒ)</code></li>
      <li><b>ì •ë‹µ íŒŒì¼(.txt)</b> â€” í•œ ì¤„ì— ì •ë‹µ ë²ˆí˜¸(1~5)</li>
      <li><b>í•´ì„¤ íŒŒì¼(.txt)</b> â€” í•œ ì¤„ì— í•´ì„¤(ì„ íƒ)</li>
    </ol>
    <div class="row">
      <div class="col"><label>ë¬¸ì œ íŒŒì¼</label><input type="file" id="impQ" accept=".txt,.csv"></div>
      <div class="col"><label>ì •ë‹µ íŒŒì¼</label><input type="file" id="impA" accept=".txt"></div>
      <div class="col"><label>í•´ì„¤ íŒŒì¼(ì„ íƒ)</label><input type="file" id="impE" accept=".txt"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="runImport">ê°€ì ¸ì™€ì„œ ì¶”ê°€</button>
    </div>
    <p class="meta">ê°€ì ¸ì˜¨ ë¬¸í•­ì€ ë¹Œë” ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ê³ , ìë™ ì €ì¥ë¼.</p>

    <hr style="margin:16px 0;border:0;border-top:1px solid #eee">

    <h4>ì˜µì…˜ B) CSV í•œ íŒŒì¼ë¡œ ê°€ì ¸ì˜¤ê¸° (ì¶”ì²œ)</h4>
    <p class="meta">CSV ì²« ì¤„(í—¤ë”): <code>ë¬¸ì œë²ˆí˜¸,ê³¼ëª©,ë‹¨ì›,ë¬¸ì œ,ë³´ê¸°1,ë³´ê¸°2,ë³´ê¸°3,ë³´ê¸°4,ë³´ê¸°5,ë‹µ,í•´ì„¤</code><br>
    í•„ìˆ˜: ê³¼ëª©/ë‹¨ì›/ë¬¸ì œ/ë³´ê¸°1/ë³´ê¸°2/ë‹µ(ìˆ«ì 1~5). ì‰¼í‘œê°€ ë“¤ì–´ê°€ë©´ "ë”°ì˜´í‘œ"ë¡œ ê°ì‹¸ì¤˜.</p>
    <div class="row">
      <div class="col">
        <label>CSV íŒŒì¼(.csv/.tsv/.txt)</label>
        <input type="file" id="impCSV" accept=".csv,.tsv,.txt">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="runCSV">CSV ê°€ì ¸ì™€ì„œ ì¶”ê°€</button>
    </div>
  </section>
</div>

<!-- Firebase (ëª¨ë“ˆ) -->
<script type="module">
  /***** 1) Firebase ë¡œë“œ & ì´ˆê¸°í™” *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ğŸ‘‰ ì—¬ê¸°ì— ë³¸ì¸ í”„ë¡œì íŠ¸ì˜ ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ë„£ì–´ë‘ì—ˆì–´.
  const firebaseConfig = {
    apiKey: "AIzaSyCIxu4AvEDM3ajVqUp-1xVu3r_cmws5tzA",
    authDomain: "psychology-cbt.firebaseapp.com",
    projectId: "psychology-cbt",
    storageBucket: "psychology-cbt.firebasestorage.app",
    messagingSenderId: "721227780091",
    appId: "1:721227780091:web:07430b92610e553075455e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const provider = new GoogleAuthProvider();

  /***** 2) ê¸°ì¡´ ì•± ë³€ìˆ˜/í•¨ìˆ˜ë“¤ (ë™ê¸°í™” í›…ë§Œ ë°”ê¿ˆ) *****/
  const $ = id=>document.getElementById(id);
  let data = JSON.parse(localStorage.getItem("cbt_data")||"[]");
  let idx=0, correct=0, wrong=0;
  let filteredIdxs=[];
  let attempts   = JSON.parse(localStorage.getItem("cbt_attempts")||"{}");
  let wrongSet   = JSON.parse(localStorage.getItem("cbt_wrongset")||"{}");
  let correctSet = JSON.parse(localStorage.getItem("cbt_correctset")||"{}");

  // ë¹Œë”ìš©
  let buildFilteredIdxs = [];
  let buildSelected = new Set();

  function saveLocal(){
    localStorage.setItem("cbt_data", JSON.stringify(data));
    localStorage.setItem("cbt_attempts", JSON.stringify(attempts));
    localStorage.setItem("cbt_wrongset", JSON.stringify(wrongSet));
    localStorage.setItem("cbt_correctset", JSON.stringify(correctSet));
  }
  function noteCounts(){ return {w:Object.keys(wrongSet).length, c:Object.keys(correctSet).length}; }
  function refreshNoteBadge(){ const {w,c}=noteCounts(); const el=$("noteBadge"); if(el) el.textContent = `ì˜¤ë‹µë…¸íŠ¸ ${w} Â· ì •ë‹µë…¸íŠ¸ ${c}`; }
  function fillSelect(sel, arr){ if(!sel) return; sel.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join(""); }
  function getUnitsForSubject(subject){
    const set = new Set();
    data.forEach(q=>{ if(subject==="(ì „ì²´)" || q.subject===subject) set.add(q.unit); });
    return ["(ì „ì²´)", ...Array.from(set).sort()];
  }
  function updateUnitOptions(subjId, unitId){
    const sEl = $(subjId); const uEl = $(unitId);
    if(!sEl || !uEl) return;
    const s = sEl.value || "(ì „ì²´)";
    fillSelect(uEl, getUnitsForSubject(s));
  }

  // UI ì´ˆê¸°í™”(ì›ë˜ v7 ë¡œì§ ê·¸ëŒ€ë¡œ)
  buildPrepareFiltered();
  renderList();
  refreshAllFilters();
  refreshNoteBadge();
  $("filterSubject").onchange = ()=> updateUnitOptions("filterSubject","filterUnit");
  $("revSubject").onchange    = ()=> updateUnitOptions("revSubject","revUnit");
  $("buildFilterSubject").onchange = ()=> updateUnitOptions("buildFilterSubject","buildFilterUnit");
  ["onlyWrong","onlyCorrect"].forEach(id=>{ const el=$(id); if(el){ el.onchange = ()=>{ prepareFiltered(); startQuiz(); }; }});
  $("tabBuild").onclick = ()=>show("build");
  $("tabQuiz").onclick  = ()=>{ show("quiz"); prepareFiltered(); startQuiz(); };
  $("tabReview").onclick= ()=>show("review");
  $("tabImport").onclick= ()=>show("import");

  function show(which){
    const map={build:"buildSec",quiz:"quizSec",review:"reviewSec",import:"importSec"};
    Object.values(map).forEach(id=>$(id).classList.add("hidden"));
    $(map[which]).classList.remove("hidden");
    ["tabBuild","tabQuiz","tabReview","tabImport"].forEach(t=>$(t).classList.remove("active"));
    if(which==="build") $("tabBuild").classList.add("active");
    if(which==="quiz")  $("tabQuiz").classList.add("active");
    if(which==="review")$("tabReview").classList.add("active");
    if(which==="import")$("tabImport").classList.add("active");
  }

  $("clearBtn").onclick=()=>["subject","unit","question","c1","c2","c3","c4","c5","explain"].forEach(id=>$(id).value="");
  $("addBtn").onclick=()=>{
    const subject = $("subject").value.trim()||"ë¯¸ì§€ì •";
    const unit = $("unit").value.trim()||"ì¼ë°˜";
    const question = $("question").value.trim();
    const choices = ["c1","c2","c3","c4","c5"].map(id=>($(id).value||"").trim()).filter(v=>v);
    const ai = parseInt($("answerIndex").value,10)-1;
    const explanation = $("explain").value.trim();
    if(!question || choices.length<2 || isNaN(ai) || ai<0 || ai>=choices.length){
      alert("ë¬¸í•­/ë³´ê¸°(2ê°œ ì´ìƒ)/ì •ë‹µ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì¤˜."); return;
    }
    data.push({ id: genId(), subject, unit, question, choices, answerIndex: ai, explanation });
    saveAll(); // â† ë¡œì»¬+í´ë¼ìš°ë“œ
    buildPrepareFiltered();
    renderList();
    $("clearBtn").click();
    refreshAllFilters();
  };

  $("saveBtn").onclick=()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "questions.json";
    a.click();
  };

  $("loadBtn").onclick=()=>$("file").click();
  $("file").onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    f.text().then(t=>{
      try{
        const incoming = JSON.parse(t);
        if(!Array.isArray(incoming)) throw new Error("JSON ìµœìƒìœ„ëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        incoming.forEach(q=>{ q.id = genId(); });
        data = data.concat(incoming);
        saveAll();
        buildPrepareFiltered(); renderList(); refreshAllFilters(); refreshNoteBadge();
        alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
      }catch(err){ alert("JSON í˜•ì‹ ì˜¤ë¥˜: "+err.message); }
    });
  };

  $("startBtn").onclick=()=>{ if(data.length===0){ alert("ë¬¸ì œê°€ ì—†ìŒ!"); return; } prepareFiltered(); startQuiz(); show("quiz"); };
  $("backToBuild").onclick=()=>show("build");

  function renderList(){
    const box=$("listBox");
    const idxs = (buildFilteredIdxs.length ? buildFilteredIdxs : data.map((_,i)=>i));
    if(data.length===0 || idxs.length===0){
      box.innerHTML = "<div class='meta'>ì•„ì§ ì—†ìŒ. ë¬¸ì œë¥¼ ì¶”ê°€í•´ì¤˜.</div>";
      $("buildCount").textContent = 0;
      return;
    }
    box.innerHTML = idxs.map(i=>{
      const q = data[i];
      const checked = buildSelected.has(q.id) ? "checked" : "";
      return `
        <div class="item">
          <label class="meta" style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <input type="checkbox" class="sel" data-id="${q.id}" ${checked}>
            <span>#${q.id} Â· ${q.subject} / ${q.unit}</span>
          </label>
          <div>${q.question}</div>
          <div class="meta">ì •ë‹µ: ${q.answerIndex+1} | ë³´ê¸°: ${q.choices.join(" / ")}</div>
          <div class="row" style="margin-top:6px">
            <button class="btn danger" onclick="delQ(${q.id})">ê°œë³„ ì‚­ì œ</button>
          </div>
        </div>`;
    }).join("");

    Array.from(box.querySelectorAll(".sel")).forEach(chk=>{
      chk.onchange = (e)=>{
        const id = parseInt(e.target.getAttribute("data-id"),10);
        if(e.target.checked) buildSelected.add(id);
        else buildSelected.delete(id);
      };
    });
    $("buildCount").textContent = idxs.length;
  }

  window.delQ = (id)=>{
    data = data.filter(x=>x.id!==id);
    if(buildSelected.has(id)) buildSelected.delete(id);
    if(attempts[id]) delete attempts[id];
    delete wrongSet[id];
    delete correctSet[id];
    saveAll();
    buildPrepareFiltered();
    renderList(); refreshAllFilters(); refreshNoteBadge();
  };

  function genId(){
    const used = new Set(data.map(q=>q.id));
    let i = 1; while(used.has(i)) i++; return i;
  }

  function buildPrepareFiltered(){
    const s = $("buildFilterSubject") ? $("buildFilterSubject").value || "(ì „ì²´)" : "(ì „ì²´)";
    const u = $("buildFilterUnit") ? $("buildFilterUnit").value || "(ì „ì²´)" : "(ì „ì²´)";
    buildFilteredIdxs = data
      .map((q,i)=>({q,i}))
      .filter(({q})=> (s==="(ì „ì²´)"||q.subject===s) && (u==="(ì „ì²´)"||q.unit===u))
      .map(({i})=>i);
    if(buildFilteredIdxs.length===0) buildFilteredIdxs = data.map((_,i)=>i);
  }

  $("buildApplyFilter").onclick = ()=>{ buildSelected.clear(); buildPrepareFiltered(); renderList(); };
  $("buildClearFilter").onclick = ()=>{
    if($("buildFilterSubject")) $("buildFilterSubject").selectedIndex = 0;
    updateUnitOptions("buildFilterSubject","buildFilterUnit");
    if($("buildFilterUnit")) $("buildFilterUnit").selectedIndex = 0;
    buildSelected.clear();
    buildPrepareFiltered();
    renderList();
  };
  $("buildSelectAll").onclick   = ()=>{
    const box = $("listBox"); const checks = box.querySelectorAll(".sel");
    checks.forEach(ch=>{ ch.checked = true; buildSelected.add(parseInt(ch.getAttribute("data-id"),10)); });
  };
  $("buildSelectNone").onclick  = ()=>{
    const box = $("listBox"); const checks = box.querySelectorAll(".sel");
    checks.forEach(ch=>{ ch.checked = false; buildSelected.delete(parseInt(ch.getAttribute("data-id"),10)); });
  };
  $("buildSelectInvert").onclick= ()=>{
    const box = $("listBox"); const checks = box.querySelectorAll(".sel");
    checks.forEach(ch=>{
      const id = parseInt(ch.getAttribute("data-id"),10);
      const now = !ch.checked; ch.checked = now;
      if(now) buildSelected.add(id); else buildSelected.delete(id);
    });
  };
  $("buildDeleteSelected").onclick = ()=>{
    const ids = Array.from(buildSelected);
    if(ids.length===0){ alert("ì„ íƒëœ ë¬¸ì œê°€ ì—†ì–´!"); return; }
    if(!confirm(`${ids.length}ë¬¸í•­ì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)`)) return;
    const remove = new Set(ids);
    data = data.filter(q=>!remove.has(q.id));
    ids.forEach(id=>{ if(attempts[id]) delete attempts[id]; delete wrongSet[id]; delete correctSet[id]; });
    buildSelected.clear();
    saveAll();
    refreshAllFilters(); buildPrepareFiltered(); renderList(); refreshNoteBadge();
    alert("ì‚­ì œ ì™„ë£Œ!");
  };

  function refreshAllFilters(){
    const subj = Array.from(new Set(data.map(q=>q.subject))).sort();
    const unit = Array.from(new Set(data.map(q=>q.unit))).sort();
    fillSelect($("filterSubject"), ["(ì „ì²´)", ...subj]);
    fillSelect($("filterUnit"), ["(ì „ì²´)", ...unit]);
    fillSelect($("revSubject"), ["(ì „ì²´)", ...subj]);
    fillSelect($("revUnit"), ["(ì „ì²´)", ...unit]);
    updateUnitOptions("filterSubject","filterUnit");
    updateUnitOptions("revSubject","revUnit");
    if($("buildFilterSubject")) fillSelect($("buildFilterSubject"), ["(ì „ì²´)", ...subj]);
    if($("buildFilterUnit")) fillSelect($("buildFilterUnit"), ["(ì „ì²´)", ...unit]);
    updateUnitOptions("buildFilterSubject","buildFilterUnit");
  }

  function prepareFiltered(){
    const s = $("filterSubject").value;
    const u = $("filterUnit").value;
    const onlyWrong = $("onlyWrong") && $("onlyWrong").checked;
    const onlyCorrect = $("onlyCorrect") && $("onlyCorrect").checked;

    filteredIdxs = data
      .map((q,i)=>({q,i}))
      .filter(({q})=> (s==="(ì „ì²´)"||q.subject===s) && (u==="(ì „ì²´)"||q.unit===u))
      .filter(({q})=> {
        if(onlyWrong && onlyCorrect) return !!wrongSet[q.id] || !!correctSet[q.id];
        if(onlyWrong) return !!wrongSet[q.id];
        if(onlyCorrect) return !!correctSet[q.id];
        return true;
      })
      .map(({i})=>i);

    if(!onlyWrong && !onlyCorrect && filteredIdxs.length===0){
      filteredIdxs = data.map((_,i)=>i);
    }
  }

  $("applyFilter").onclick=()=>{ prepareFiltered(); startQuiz(); };
  $("clearFilter").onclick = () => {
    $("filterSubject").selectedIndex = 0;
    updateUnitOptions("filterSubject","filterUnit");
    $("filterUnit").selectedIndex = 0;
    if($("onlyWrong")) $("onlyWrong").checked = false;
    if($("onlyCorrect")) $("onlyCorrect").checked = false;
    prepareFiltered();
    startQuiz();
  };

  function startQuiz(){
    idx=0; correct=0; wrong=0;
    if ($("showAll") && $("showAll").checked) {
      setAllModeUI(true);  renderQuizAll();
    } else {
      setAllModeUI(false); renderQuiz();
    }
  }

  function renderQuiz(){
    const total = filteredIdxs.length;
    $("idx").textContent = total? idx+1:0;
    $("total").textContent = total;
    $("good").textContent = correct;
    $("bad").textContent = wrong;
    $("bar").style.width = (total? (idx/total*100):0) + "%";
    if(total===0){ $("qtext").textContent="í•´ë‹¹ í•„í„°ì— ë¬¸ì œê°€ ì—†ì–´ìš”."; $("choices").innerHTML=""; $("exp").textContent=""; return; }
    const q = data[filteredIdxs[idx]];
    $("subjectNow").textContent = `${q.subject} / ${q.unit}`;
    $("qtext").textContent = q.id+". "+q.question;
    $("exp").textContent = "";
    $("choices").innerHTML = q.choices.map((c,i)=>`<button onclick="choose(${i})">${i+1}. ${c}</button>`).join("");
    $("prevBtn").disabled = idx===0;
    $("nextBtn").textContent = (idx===total-1) ? "ê²°ê³¼" : "ë‹¤ìŒ";
  }

  function setAllModeUI(on){
    $("prevBtn").style.display = on ? "none" : "";
    $("nextBtn").style.display = on ? "none" : "";
  }

  function renderQuizAll(){
    const total = filteredIdxs.length;
    $("idx").textContent = 0;
    $("total").textContent = total;
    $("good").textContent = correct;
    $("bad").textContent = wrong;
    $("bar").style.width = "0%";
    if(total===0){
      $("qtext").textContent="í•´ë‹¹ í•„í„°ì— ë¬¸ì œê°€ ì—†ì–´ìš”.";
      $("choices").innerHTML=""; $("exp").textContent="";
      return;
    }
    $("subjectNow").textContent = "(ì „ì²´ ë³´ê¸° ëª¨ë“œ) ì„ íƒëœ ë¬¸í•­ " + total + "ê°œ";
    $("qtext").textContent = "ì•„ë˜ì—ì„œ ë°”ë¡œ í’€ì–´ë´!";
    $("exp").textContent = "";

    const html = filteredIdxs.map((di, k)=>{
      const q = data[di];
      const buttons = q.choices.map((c,i)=>`
        <button onclick="chooseAll(${k}, ${i})">${i+1}. ${c}</button>
      `).join("");
      return `
        <div class="item" id="qblock_${k}">
          <div class="meta">#${q.id} Â· ${q.subject} / ${q.unit}</div>
          <div style="font-weight:600;margin:6px 0">${q.question}</div>
          <div class="choices" id="choices_all_${k}">${buttons}</div>
          <p class="meta" id="exp_all_${k}" style="margin-top:6px"></p>
        </div>
      `;
    }).join("");
    $("choices").innerHTML = html;
  }

  function recordResult(q, ok, choiceIndex){
    attempts[q.id] = { lastState: ok?"correct":"wrong", lastChoice: choiceIndex };
    if(ok){ delete wrongSet[q.id]; correctSet[q.id] = true; }
    else { wrongSet[q.id] = true; delete correctSet[q.id]; }
    refreshNoteBadge();
    saveAll(); // ê²°ê³¼ë„ ì¦‰ì‹œ ë™ê¸°í™”
  }

  window.chooseAll = (k, i)=>{
    const di = filteredIdxs[k];
    const q = data[di];
    const choicesBox = document.getElementById("choices_all_"+k);
    if(!choicesBox) return;
    if(Array.from(choicesBox.children).some(b=>b.disabled)) return;

    Array.from(choicesBox.children).forEach((b,j)=>{
      b.disabled = true;
      if(j===q.answerIndex) b.classList.add("correct");
      if(j===i && i!==q.answerIndex) b.classList.add("wrong");
    });
    const ok = (i===q.answerIndex);
    document.getElementById("exp_all_"+k).textContent =
      (ok? "ì •ë‹µ! " : "ì˜¤ë‹µ. ì •ë‹µì€ " + (q.answerIndex+1) + "ë²ˆ. ") + (q.explanation||"");
    if(ok) correct++; else wrong++;
    $("good").textContent = correct; $("bad").textContent = wrong;
    recordResult(q, ok, i);
  };

  window.choose = (i)=>{
    const q = data[filteredIdxs[idx]];
    [...$("choices").children].forEach((b,j)=>{
      b.disabled = true;
      if(j===q.answerIndex) b.classList.add("correct");
      if(j===i && i!==q.answerIndex) b.classList.add("wrong");
    });
    const ok = (i===q.answerIndex);
    $("exp").textContent = (ok? "ì •ë‹µ! ":"ì˜¤ë‹µ. ì •ë‹µì€ "+(q.answerIndex+1)+"ë²ˆ. ") + (q.explanation||"");
    if(ok) correct++; else wrong++;
    $("good").textContent = correct; $("bad").textContent = wrong;
    recordResult(q, ok, i);
  };

  $("prevBtn").onclick=()=>{ if(idx>0){ idx--; renderQuiz(); } };
  $("nextBtn").onclick=()=>{ const total=filteredIdxs.length; if(idx<total-1){ idx++; renderQuiz(); } else { alert(`ë! ì •ë‹µ ${correct}, ì˜¤ë‹µ ${wrong}`); } };

  $("revApply").onclick=()=>renderReview();
  $("exportWrong").onclick=()=>exportByState("wrong");
  $("exportCorrect").onclick=()=>exportByState("correct");
  $("exportWrongSet").onclick=()=>exportSet("wrong");
  $("exportCorrectSet").onclick=()=>exportSet("correct");
  $("clearWrongSet").onclick=()=>{ if(confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ë¹„ìš¸ê¹Œìš”?")){ wrongSet={}; saveAll(); refreshNoteBadge(); alert("ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ"); } };
  $("clearCorrectSet").onclick=()=>{ if(confirm("ì •ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ë¹„ìš¸ê¹Œìš”?")){ correctSet={}; saveAll(); refreshNoteBadge(); alert("ì •ë‹µë…¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ"); } };

  function renderReview(){
    const s = $("revSubject").value;
    const u = $("revUnit").value;
    const st = $("revState").value;
    const rows = data.filter(q=> (s==="(ì „ì²´)"||q.subject===s) && (u==="(ì „ì²´)"||q.unit===u))
      .map(q=>{
        const att = attempts[q.id];
        const state = att?.lastState || "-";
        const my = att?.lastChoice!=null ? (q.choices[att.lastChoice]||"-") : "-";
        const ans = q.choices[q.answerIndex]||"-";
        return {q, state, my, ans};
      })
      .filter(r=> st==="all" ? true : r.state===st);

    $("revBody").innerHTML = rows.map((r,i)=>`<tr>
      <td>${i+1}</td>
      <td>${r.q.subject}</td>
      <td>${r.q.unit}</td>
      <td>${r.q.question}</td>
      <td>${r.my}</td>
      <td>${r.ans}</td>
      <td>${r.state}</td>
    </tr>`).join("");
  }

  function exportByState(state){
    const out = data.filter(q=>{ const st = attempts[q.id]?.lastState; return state==="all"? true : st===state; });
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = state+"_questions_recent.json";
    a.click();
  }

  function exportSet(which){
    const ids = which==="wrong" ? wrongSet : correctSet;
    const out = data.filter(q=> !!ids[q.id]);
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = which+"_note_accumulated.json";
    a.click();
  }

  $("runImport").onclick=async()=>{
    const fq = $("impQ").files[0];
    const fa = $("impA").files[0];
    const fe = $("impE").files[0];
    if(!fq || !fa){ alert("ë¬¸ì œ íŒŒì¼ê³¼ ì •ë‹µ íŒŒì¼ì€ í•„ìˆ˜!"); return; }
    const [tq, ta, te] = await Promise.all([fq.text(), fa.text(), fe?fe.text():Promise.resolve("")]);
    const qLines = tq.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const aLines = ta.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const eLines = te.split(/\r?\n/).map(s=>s.trim());
    const N = Math.min(qLines.length, aLines.length);
    let added=0;
    for(let i=0;i<N;i++){
      const parts = qLines[i].split("|").map(s=>s.trim());
      const subject = parts[0]||"ë¯¸ì§€ì •";
      const unit = parts[1]||"ì¼ë°˜";
      const question = parts[2]||"";
      const choices = parts.slice(3).filter(Boolean);
      const ansIdx = parseInt(aLines[i],10) - 1;
      const explanation = eLines[i]||"";
      if(!question || choices.length<2 || isNaN(ansIdx) || ansIdx<0 || ansIdx>=choices.length){ continue; }
      data.push({ id: genId(), subject, unit, question, choices, answerIndex: ansIdx, explanation });
      added++;
    }
    saveAll(); buildPrepareFiltered(); renderList(); refreshAllFilters();
    alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${added}ë¬¸í•­ ì¶”ê°€`);
  };

  $("runCSV").onclick=async()=>{
    const f = $("impCSV").files[0];
    if(!f){ alert("CSV íŒŒì¼ì„ ì„ íƒí•´ì¤˜!"); return; }
    const txt = await f.text();
    const rows = parseCSV(txt);
    if(rows.length < 2){ alert("CSVì— ë°ì´í„°ê°€ ì—†ì–´ìš”."); return; }
    const header = rows[0].map(h=>h.trim());
    const col = name => header.indexOf(name);
    const idxNo  = col("ë¬¸ì œë²ˆí˜¸");
    const idxSub = col("ê³¼ëª©");
    const idxUnit= col("ë‹¨ì›");
    const idxQ   = col("ë¬¸ì œ");
    const idxC1  = col("ë³´ê¸°1");
    const idxC2  = col("ë³´ê¸°2");
    const idxC3  = col("ë³´ê¸°3");
    const idxC4  = col("ë³´ê¸°4");
    const idxC5  = col("ë³´ê¸°5");
    const idxAns = col("ë‹µ");
    const idxExp = col("í•´ì„¤");
    const need = [idxSub, idxUnit, idxQ, idxC1, idxC2, idxAns];
    if(need.some(i=>i < 0)){
      alert("í•„ìˆ˜ í—¤ë”(ê³¼ëª©, ë‹¨ì›, ë¬¸ì œ, ë³´ê¸°1, ë³´ê¸°2, ë‹µ)ê°€ í•„ìš”í•´ìš”.");
      return;
    }
    let added = 0;
    for(let r=1; r<rows.length; r++){
      const row = rows[r];
      if(row.length===1 && !(row[0]||"").trim()) continue;
      const subject = (row[idxSub] || "ë¯¸ì§€ì •").trim();
      const unit    = (row[idxUnit]|| "ì¼ë°˜").trim();
      const question= (row[idxQ]   || "").trim();
      const choices = [idxC1,idxC2,idxC3,idxC4,idxC5].filter(i=>i>=0).map(i=> (row[i]||"").trim()).filter(Boolean);
      const ansIdx = parseInt((row[idxAns]||"").trim(), 10) - 1;
      const explanation = idxExp>=0 ? (row[idxExp]||"").trim() : "";
      if(!question || choices.length < 2 || isNaN(ansIdx) || ansIdx<0 || ansIdx>=choices.length) continue;
      data.push({ id: genId(), subject, unit, question, choices, answerIndex: ansIdx, explanation });
      added++;
    }
    saveAll(); buildPrepareFiltered(); renderList(); refreshAllFilters();
    alert(`CSV ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${added}ë¬¸í•­ ì¶”ê°€`);
  };

  function parseCSV(text){
    const sep = text.includes("\t") ? "\t" : ",";
    const rows = [];
    let cur = [], field = "", inQuotes = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){ field += '"'; i++; }
          else { inQuotes = false; }
        }else{ field += ch; }
      }else{
        if(ch === '"') inQuotes = true;
        else if(ch === sep){ cur.push(field); field = ""; }
        else if(ch === "\n"){ cur.push(field); rows.push(cur); cur = []; field = ""; }
        else if(ch === "\r"){ }
        else { field += ch; }
      }
    }
    cur.push(field); rows.push(cur);
    return rows.filter(r => r.length>1 || (r[0] && r[0].trim()));
  }

  /***** 3) Firestore ë™ê¸°í™” ë ˆì´ì–´ *****/
  // í•œ ë¬¸ì„œì— ì „ì²´ ì €ì¥ (ê°„ë‹¨ ë²„ì „). í° ë°ì´í„°ê°€ ë˜ë©´ ë¶„í•  ì €ì¥ìœ¼ë¡œ ë°”ê¾¸ì.
  // ê²½ë¡œ: users/{uid}/app/appdata
  let unsub = null;      // onSnapshot í•´ì œìš©
  let syncing = false;   // ë‚´ê°€ ì €ì¥í•´ì„œ ìƒê¸´ ë³€ê²½ì„ ë‹¤ì‹œ ì ìš©í•˜ì§€ ì•Šë„ë¡

  function pack(){
    return {
      data, attempts, wrongSet, correctSet,
      updatedAt: Date.now(),
      schema: "v1"
    };
  }
  function applyFromCloud(payload){
    data       = payload.data       || [];
    attempts   = payload.attempts   || {};
    wrongSet   = payload.wrongSet   || {};
    correctSet = payload.correctSet || {};
    saveLocal(); // ë¡œì»¬ ìºì‹œ ê°±ì‹ 
    // í™”ë©´ ì—…ë°ì´íŠ¸
    buildPrepareFiltered(); renderList(); refreshAllFilters(); refreshNoteBadge();
    // í€´ì¦ˆ í™”ë©´ì´ë©´ ì¬ë Œë”
    if(!$("buildSec").classList.contains("hidden")){} else { prepareFiltered(); startQuiz(); }
  }

  // ë””ë°”ìš´ìŠ¤ ì €ì¥(ë¹ ë¥´ê²Œ ì—¬ëŸ¬ ë²ˆ ì €ì¥í•´ë„ 0.7ì´ˆì— í•œë²ˆ)
  let saveTimer = null;
  function saveAll(){
    saveLocal(); // í•­ìƒ ë¡œì»¬ì—ë„
    const user = auth.currentUser;
    if(!user){ return; } // ë¯¸ë¡œê·¸ì¸: ë¡œì»¬ì—ë§Œ
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async()=>{
      try{
        syncing = true;
        const ref = doc(db, "users", user.uid, "app", "appdata");
        await setDoc(ref, pack(), { merge: true });
      }catch(e){
        console.error("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨:", e);
      }finally{
        setTimeout(()=>{ syncing = false; }, 200);
      }
    }, 700);
  }

  async function attachRealtime(){
    const user = auth.currentUser;
    if(!user) return;
    const ref = doc(db, "users", user.uid, "app", "appdata");

    // ìµœì´ˆ ë¡œë“œ
    const snap = await getDoc(ref);
    if(!snap.exists()){
      // í´ë¼ìš°ë“œ ë¹„ì–´ìˆê³  ë¡œì»¬ì— ë­”ê°€ ìˆìœ¼ë©´ ì—…ë¡œë“œí• ì§€ ë¬¼ì–´ë´„
      const hasLocal = (data.length || Object.keys(attempts).length || Object.keys(wrongSet).length || Object.keys(correctSet).length);
      if(hasLocal){
        const ok = confirm("í´ë¼ìš°ë“œì— ë°ì´í„°ê°€ ì—†ì–´ìš”. ì§€ê¸ˆ ì´ ê¸°ê¸°ì˜ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí• ê¹Œìš”?");
        if(ok){ await setDoc(ref, pack(), { merge: true }); }
        else { /* ì•„ë¬´ ê²ƒë„ ì•ˆí•¨(ë¹ˆ ìƒíƒœ ìœ ì§€) */ }
      }else{
        // ë‘˜ ë‹¤ ë¹„ì—ˆìœ¼ë©´ ê·¸ëŒ€ë¡œ
        await setDoc(ref, pack(), { merge: true });
      }
    }else{
      // í´ë¼ìš°ë“œì— ìˆìŒ â†’ í´ë¼ìš°ë“œ ìš°ì„  ì ìš©
      applyFromCloud(snap.data());
    }

    // ì‹¤ì‹œê°„ êµ¬ë…
    if(unsub) unsub();
    unsub = onSnapshot(ref, (docSnap)=>{
      if(!docSnap.exists()) return;
      if(syncing) return; // ë‚´ê°€ ë°©ê¸ˆ ì“´ ë³€ê²½ì´ë©´ ë¬´ì‹œ
      const payload = docSnap.data();
      applyFromCloud(payload);
    });
  }

  function detachRealtime(){
    if(unsub){ unsub(); unsub=null; }
  }

  /***** 4) ë¡œê·¸ì¸ UI *****/
  const btnSignIn = $("btnSignIn");
  const btnSignOut= $("btnSignOut");
  const userInfo  = $("userInfo");

  btnSignIn.onclick = async ()=>{
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message);
    }
  };
  btnSignOut.onclick = async ()=>{
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      userInfo.textContent = `${user.displayName||user.email||"ì‚¬ìš©ì"} Â· ë¡œê·¸ì¸ë¨`;
      btnSignIn.style.display="none";
      btnSignOut.style.display="";
      await attachRealtime(); // ë¡œê·¸ì¸ë˜ë©´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘
    }else{
      userInfo.textContent = "ë¡œê·¸ì¸ í•„ìš”";
      btnSignIn.style.display="";
      btnSignOut.style.display="none";
      detachRealtime(); // êµ¬ë… í•´ì œ
    }
  });
</script>
</body>
</html>
