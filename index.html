<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CBT 만들기 & 풀기 — 일상방 31 (v8 · Firebase)</title>
<style>
  :root{--gap:12px;--radius:12px}
  body{font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Arial;margin:0;background:#f7f7fb;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .card{background:#fff;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin-top:12px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{display:block;margin:6px 0 4px;font-size:13px;color:#444}
  input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
  textarea{min-height:90px;resize:vertical}
  .btn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.danger{border-color:#b42318;color:#b42318;background:#fff}
  .list{max-height:260px;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px}
  .item{border:1px solid #eee;border-radius:10px;padding:8px;margin-bottom:8px}
  .meta{font-size:12px;color:#666}
  .hidden{display:none !important}
  .choices button{display:block;width:100%;text-align:left;margin-top:8px;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .choices button.correct{border-color:#1a7f37;background:#e9f7ee}
  .choices button.wrong{border-color:#b42318;background:#fdecea}
  .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 0}
  .bar{height:100%;background:#111;width:0}
  .pill{background:#eef0f3;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  .note-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .authbar{display:flex;gap:8px;align-items:center}
  .dim{opacity:.5}

  /* 해설 줄바꿈 처리 */
  #exp, [id^="exp_all_"] {
    white-space: pre-line;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>CBT 만들기 & 풀기 <span class="pill">일상방 31</span></h1>

    <div class="tabs">
      <button class="tab active" id="tabBuild">문제 만들기</button>
      <button class="tab" id="tabQuiz">문제 풀기</button>
      <button class="tab" id="tabReview">리뷰(정답/오답 모아보기)</button>
      <button class="tab" id="tabImport">대량 가져오기</button>
    </div>

    <div class="authbar">
      <span class="pill" id="noteBadge">오답노트 0 · 정답노트 0</span>
      <span class="meta" id="syncBadge">오프라인</span>
      <button class="btn" id="loginBtn">Google 로그인</button>
      <button class="btn hidden" id="logoutBtn">로그아웃</button>
      <span class="meta" id="whoAmI"></span>
    </div>
  </header>

  <!-- 빌더 -->
  <section class="card" id="buildSec">
    <div class="row">
      <div class="col"><label>과목</label><input id="subject" placeholder="예: 직업상담학" /></div>
      <div class="col"><label>단원</label><input id="unit" placeholder="예: 3장 의사결정" /></div>
      <div class="col"><label>정답 번호(1~5)</label><input id="answerIndex" type="number" min="1" max="5" value="1" /></div>
    </div>
    <label>문제</label>
    <textarea id="question" placeholder="문제 내용을 입력"></textarea>

    <div class="row">
      <div class="col"><label>보기 1</label><input id="c1" /></div>
      <div class="col"><label>보기 2</label><input id="c2" /></div>
      <div class="col"><label>보기 3</label><input id="c3" /></div>
      <div class="col"><label>보기 4</label><input id="c4" /></div>
      <div class="col"><label>보기 5(선택)</label><input id="c5" /></div>
    </div>

    <label>해설(선택)</label>
    <textarea id="explain" placeholder="정답 근거/설명"></textarea>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="clearBtn">입력 지우기</button>
      <button class="btn primary" id="addBtn">문제 추가</button>
      <div style="flex:1"></div>
      <input type="file" id="file" class="hidden" accept=".json">
      <button class="btn" id="loadBtn">JSON 불러오기</button>
      <button class="btn" id="saveBtn">JSON 내보내기(백업)</button>
      <button class="btn" id="startBtn">퀴즈 시작</button>
    </div>

    <!-- 빌더용 필터/선택/삭제 -->
    <div class="filter-row" id="buildFilterRow" style="margin-top:12px">
      <label>과목</label>
      <select id="buildFilterSubject"></select>
      <label>단원</label>
      <select id="buildFilterUnit"></select>
      <button class="btn" id="buildApplyFilter">필터 적용</button>
      <button class="btn" id="buildClearFilter">필터 초기화</button>
      <div style="flex:1"></div>
      <span class="meta">표시: <span id="buildCount">0</span>문항</span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="buildSelectAll">전체 선택</button>
      <button class="btn" id="buildSelectNone">선택 해제</button>
      <button class="btn" id="buildSelectInvert">선택 반전</button>
      <div style="flex:1"></div>
      <button class="btn danger" id="buildDeleteSelected">선택 삭제</button>
    </div>

    <h3 style="margin:14px 0 8px">현재 문제 리스트</h3>
    <div class="list" id="listBox"></div>
    <p class="meta">※ 로그인한 계정의 클라우드(Firestore)에 자동 저장·동기화됩니다. (백업용으로 JSON 내보내기 가능)</p>
  </section>

  <!-- 퀴즈 -->
  <section class="card hidden" id="quizSec">
    <div class="filter-row">
      <label>과목</label>
      <select id="filterSubject"></select>
      <label>단원</label>
      <select id="filterUnit"></select>
      <button class="btn" id="applyFilter">필터 적용</button>
      <button class="btn" id="clearFilter">필터 초기화</button>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="showAll"> 한번에 전체 보기</label>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="onlyWrong"> 오답노트만</label>
      <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="onlyCorrect"> 정답노트만</label>
    </div>

    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
      <div class="meta">문항 <span id="idx">0</span> / <span id="total">0</span></div>
      <div class="meta">정답 <span id="good">0</span> · 오답 <span id="bad">0</span></div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>

    <p class="meta" id="subjectNow"></p>
    <h2 id="qtext" style="margin:8px 0 6px">문제를 추가하고 시작을 눌러줘.</h2>
    <div id="choices" class="choices"></div>
    <p id="exp" class="meta"></p>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="prevBtn">이전</button>
      <button class="btn" id="backToBuild">문제 만들기로</button>
      <div style="flex:1"></div>
      <button class="btn primary" id="nextBtn">다음</button>
    </div>
  </section>

  <!-- 리뷰 -->
  <section class="card hidden" id="reviewSec">
    <div class="filter-row">
      <label>과목</label>
      <select id="revSubject"></select>
      <label>단원</label>
      <select id="revUnit"></select>
      <label>상태</label>
      <select id="revState">
        <option value="all">전체</option>
        <option value="correct">정답</option>
        <option value="wrong">오답</option>
      </select>
      <button class="btn" id="revApply">보기</button>
      <button class="btn" id="exportWrong">오답JSON(최근상태)</button>
      <button class="btn" id="exportCorrect">정답JSON(최근상태)</button>
    </div>

    <div class="note-actions">
      <button class="btn" id="exportWrongSet">오답노트 JSON(누적)</button>
      <button class="btn" id="exportCorrectSet">정답노트 JSON(누적)</button>
      <button class="btn danger" id="clearWrongSet">오답노트 초기화</button>
      <button class="btn danger" id="clearCorrectSet">정답노트 초기화</button>
    </div>

    <div style="margin-top:10px">
      <table>
        <thead><tr><th>#</th><th>과목</th><th>단원</th><th>문제</th><th>내 선택</th><th>정답</th><th>상태</th></tr></thead>
        <tbody id="revBody"></tbody>
      </table>
    </div>
  </section>

  <!-- 대량 가져오기 -->
  <section class="card hidden" id="importSec">
    <p class="meta">세 파일을 업로드하면 줄 단위로 병합해서 문제를 자동 생성해줘.</p>
    <ol>
      <li><b>문제 파일(.txt/.csv)</b> — 한 줄씩 <code>과목|단원|문제|보기1|보기2|보기3|보기4|보기5(선택)</code></li>
      <li><b>정답 파일(.txt)</b> — 한 줄에 정답 번호(1~5)</li>
      <li><b>해설 파일(.txt)</b> — 한 줄에 해설(선택)</li>
    </ol>
    <div class="row">
      <div class="col"><label>문제 파일</label><input type="file" id="impQ" accept=".txt,.csv"></div>
      <div class="col"><label>정답 파일</label><input type="file" id="impA" accept=".txt"></div>
      <div class="col"><label>해설 파일(선택)</label><input type="file" id="impE" accept=".txt"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="runImport">가져와서 추가</button>
    </div>
    <p class="meta">가져온 문항은 빌더 리스트에 추가되고, 자동 저장돼.</p>

    <hr style="margin:16px 0;border:0;border-top:1px solid #eee">

    <h4>옵션 B) CSV 한 파일로 가져오기 (추천)</h4>
    <p class="meta">CSV 첫 줄(헤더): <code>문제번호,과목,단원,문제,보기1,보기2,보기3,보기4,보기5,답,해설</code></p>
    <div class="row">
      <div class="col">
        <label>CSV 파일(.csv/.tsv/.txt)</label>
        <input type="file" id="impCSV" accept=".csv,.tsv,.txt">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="runCSV">CSV 가져와서 추가</button>
    </div>
  </section>
</div>

<!-- Firebase SDK (CDN, 모듈 방식 v9+) -->
<script type="module">
/* ======== 1) Firebase 초기화 ======== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* 콘솔에서 받은 설정 (네 프로젝트 값) */
const firebaseConfig = {
  apiKey: "AIzaSyCIxu4AvEDM3ajVqUp-1xVu3r_cmws5tzA",
  authDomain: "psychology-cbt.firebaseapp.com",
  projectId: "psychology-cbt",
  storageBucket: "psychology-cbt.firebasestorage.app",
  messagingSenderId: "721227780091",
  appId: "1:721227780091:web:07430b92610e553075455e"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* 오프라인 캐시 */
enableIndexedDbPersistence(db).catch(()=>{});

/* ======== 2) 공용 ======== */
const $ = id=>document.getElementById(id);
let user = null;

/* 상태 */
let data = [];                         // 문항 배열
let idx=0, correct=0, wrong=0;
let filteredIdxs=[];
let attempts = {};                     // {qid: {lastState, lastChoice}}
let wrongSet = {};                     // {qid:true}
let correctSet = {};                   // {qid:true}

/* 빌더 전용 */
let buildFilteredIdxs = [];
let buildSelected = new Set();

/* 로컬 백업 */
function backupSave(){
  localStorage.setItem("cbt_backup", JSON.stringify({data, attempts, wrongSet, correctSet}));
}
function backupLoad(){
  try{
    const b = JSON.parse(localStorage.getItem("cbt_backup")||"null");
    if(b){ data=b.data||[]; attempts=b.attempts||{}; wrongSet=b.wrongSet||{}; correctSet=b.correctSet||{}; }
  }catch{}
}

/* 클라우드 저장/로드 */
function cloudDocRef(){
  if(!user) return null;
  return doc(db, "users", user.uid, "app", "bundle");
}
let saveTimer = null;
function saveCloud(debounceMs=800){
  if(!user) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    const payload = { data, attempts, wrongSet, correctSet, ts: Date.now() };
    try{
      await setDoc(cloudDocRef(), payload, { merge:true });
      $("syncBadge").textContent = "동기화 완료";
      $("syncBadge").classList.remove("dim");
      backupSave();
    }catch(e){
      $("syncBadge").textContent = "저장 실패(오프라인?)";
      $("syncBadge").classList.add("dim");
    }
  }, debounceMs);
}
async function loadCloud(){
  if(!user) return;
  $("syncBadge").textContent = "불러오는 중…";
  $("syncBadge").classList.add("dim");
  try{
    const snap = await getDoc(cloudDocRef());
    if(snap.exists()){
      const b = snap.data();
      data = b.data||[]; attempts = b.attempts||{}; wrongSet = b.wrongSet||{}; correctSet = b.correctSet||{};
    }else{
      await setDoc(cloudDocRef(), {data:[], attempts:{}, wrongSet:{}, correctSet:{}, ts: Date.now()});
      data=[]; attempts={}; wrongSet={}; correctSet={};
    }
    $("syncBadge").textContent = "동기화됨";
    $("syncBadge").classList.remove("dim");
    backupSave();
  }catch(e){
    $("syncBadge").textContent = "오프라인(백업 사용)";
    $("syncBadge").classList.add("dim");
    backupLoad();
  }
}

/* 로그인 전 차단 */
function disableAppUntilLogin(lock){
  const needsAuth = document.querySelectorAll("#buildSec .btn, #quizSec .btn, #reviewSec .btn, #importSec .btn, input, textarea, select");
  needsAuth.forEach(el=>{
    if(lock){
      el.setAttribute("disabled","disabled");
      el.classList.add("dim");
    }else{
      el.removeAttribute("disabled");
      el.classList.remove("dim");
    }
  });
  $("loginBtn").removeAttribute("disabled");
}

/* 공통 뷰 업데이트 */
function noteCounts(){ return {w:Object.keys(wrongSet).length, c:Object.keys(correctSet).length}; }
function refreshNoteBadge(){ const {w,c}=noteCounts(); const el=$("noteBadge"); if(el) el.textContent = `오답노트 ${w} · 정답노트 ${c}`; }

function initAfterDataLoad(){
  disableAppUntilLogin(false);
  buildPrepareFiltered();
  renderList();
  refreshAllFilters();
  refreshNoteBadge();
}

/* 탭 전환 */
function show(which){
  const map={build:"buildSec",quiz:"quizSec",review:"reviewSec",import:"importSec"};
  Object.values(map).forEach(id=>$(id).classList.add("hidden"));
  $(map[which]).classList.remove("hidden");
  ["tabBuild","tabQuiz","tabReview","tabImport"].forEach(t=>$(t).classList.remove("active"));
  if(which==="build") $("tabBuild").classList.add("active");
  if(which==="quiz")  $("tabQuiz").classList.add("active");
  if(which==="review")$("tabReview").classList.add("active");
  if(which==="import")$("tabImport").classList.add("active");
}

/* 빌더 렌더 */
function renderList(){
  const box=$("listBox");
  const idxs = (buildFilteredIdxs.length ? buildFilteredIdxs : data.map((_,i)=>i));
  if(data.length===0 || idxs.length===0){
    box.innerHTML = "<div class='meta'>아직 없음. 문제를 추가해줘.</div>";
    $("buildCount").textContent = 0; return;
  }
  box.innerHTML = idxs.map(i=>{
    const q = data[i];
    const checked = buildSelected.has(q.id) ? "checked" : "";
    return `
      <div class="item">
        <label class="meta" style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <input type="checkbox" class="sel" data-id="${q.id}" ${checked}>
          <span>#${q.id} · ${q.subject} / ${q.unit}</span>
        </label>
        <div>${q.question}</div>
        <div class="meta">정답: ${q.answerIndex+1} | 보기: ${q.choices.join(" / ")}</div>
        <div class="row" style="margin-top:6px">
          <button class="btn danger" onclick="delQ(${q.id})">개별 삭제</button>
        </div>
      </div>`;
  }).join("");

  Array.from(box.querySelectorAll(".sel")).forEach(chk=>{
    chk.onchange = (e)=>{
      const id = parseInt(e.target.getAttribute("data-id"),10);
      if(e.target.checked) buildSelected.add(id); else buildSelected.delete(id);
    };
  });
  $("buildCount").textContent = idxs.length;
}
window.delQ = (id)=>{
  data = data.filter(x=>x.id!==id);
  if(buildSelected.has(id)) buildSelected.delete(id);
  if(attempts[id]) delete attempts[id];
  delete wrongSet[id]; delete correctSet[id];
  buildPrepareFiltered(); renderList(); refreshAllFilters(); refreshNoteBadge();
  saveCloud();
};
function genId(){ const used = new Set(data.map(q=>q.id)); let i = 1; while(used.has(i)) i++; return i; }
function buildPrepareFiltered(){
  const s = $("buildFilterSubject") ? $("buildFilterSubject").value || "(전체)" : "(전체)";
  const u = $("buildFilterUnit") ? $("buildFilterUnit").value || "(전체)" : "(전체)";
  buildFilteredIdxs = data.map((q,i)=>({q,i}))
    .filter(({q})=> (s==="(전체)"||q.subject===s) && (u==="(전체)"||q.unit===u))
    .map(({i})=>i);
  if(buildFilteredIdxs.length===0) buildFilteredIdxs = data.map((_,i)=>i);
}

/* 공통 필터 */
function refreshAllFilters(){
  const subj = Array.from(new Set(data.map(q=>q.subject))).sort();
  const unit = Array.from(new Set(data.map(q=>q.unit))).sort();
  // 퀴즈/리뷰
  fillSelect($("filterSubject"), ["(전체)", ...subj]);
  fillSelect($("filterUnit"), ["(전체)", ...unit]);
  fillSelect($("revSubject"), ["(전체)", ...subj]);
  fillSelect($("revUnit"), ["(전체)", ...unit]);
  updateUnitOptions("filterSubject","filterUnit");
  updateUnitOptions("revSubject","revUnit");
  // 빌더
  if($("buildFilterSubject")) fillSelect($("buildFilterSubject"), ["(전체)", ...subj]);
  if($("buildFilterUnit")) fillSelect($("buildFilterUnit"), ["(전체)", ...unit]);
  updateUnitOptions("buildFilterSubject","buildFilterUnit");
}
function fillSelect(sel, arr){ if(!sel) return; sel.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join(""); }
function getUnitsForSubject(subject){ const set = new Set(); data.forEach(q=>{ if(subject==="(전체)" || q.subject===subject) set.add(q.unit); }); return ["(전체)", ...Array.from(set).sort()]; }
function updateUnitOptions(subjId, unitId){ const sEl=$(subjId), uEl=$(unitId); if(!sEl||!uEl) return; const s = sEl.value || "(전체)"; fillSelect(uEl, getUnitsForSubject(s)); }

/* 퀴즈 */
function prepareFiltered(){
  const s = $("filterSubject").value;
  const u = $("filterUnit").value;
  const onlyWrong = $("onlyWrong") && $("onlyWrong").checked;
  const onlyCorrect = $("onlyCorrect") && $("onlyCorrect").checked;
  filteredIdxs = data.map((q,i)=>({q,i}))
    .filter(({q})=> (s==="(전체)"||q.subject===s) && (u==="(전체)"||q.unit===u))
    .filter(({q})=>{
      if(onlyWrong && onlyCorrect) return !!wrongSet[q.id] || !!correctSet[q.id];
      if(onlyWrong) return !!wrongSet[q.id];
      if(onlyCorrect) return !!correctSet[q.id];
      return true;
    }).map(({i})=>i);
  if(!onlyWrong && !onlyCorrect && filteredIdxs.length===0) filteredIdxs = data.map((_,i)=>i);
}
function startQuiz(){ idx=0; correct=0; wrong=0;
  if ($("showAll") && $("showAll").checked) { setAllModeUI(true); renderQuizAll(); }
  else { setAllModeUI(false); renderQuiz(); }
}
function renderQuiz(){
  const total = filteredIdxs.length;
  $("idx").textContent = total? idx+1:0;
  $("total").textContent = total;
  $("good").textContent = correct; $("bad").textContent = wrong;
  $("bar").style.width = (total? (idx/total*100):0) + "%";
  if(total===0){ $("qtext").textContent="해당 필터에 문제가 없어요."; $("choices").innerHTML=""; $("exp").textContent=""; return; }
  const q = data[filteredIdxs[idx]];
  $("subjectNow").textContent = `${q.subject} / ${q.unit}`;
  $("qtext").textContent = q.id+". "+q.question;
  $("exp").textContent = "";
  $("choices").innerHTML = q.choices.map((c,i)=>`<button onclick="choose(${i})">${i+1}. ${c}</button>`).join("");
  $("prevBtn").disabled = idx===0;
  $("nextBtn").textContent = (idx===total-1) ? "결과" : "다음";
}
function setAllModeUI(on){ $("prevBtn").style.display = on ? "none" : ""; $("nextBtn").style.display = on ? "none" : ""; }
function renderQuizAll(){
  const total = filteredIdxs.length;
  $("idx").textContent = 0; $("total").textContent = total;
  $("good").textContent = correct; $("bad").textContent = wrong; $("bar").style.width = "0%";
  if(total===0){ $("qtext").textContent="해당 필터에 문제가 없어요."; $("choices").innerHTML=""; $("exp").textContent=""; return; }
  $("subjectNow").textContent = "(전체 보기 모드) 선택된 문항 " + total + "개";
  $("qtext").textContent = "아래에서 바로 풀어봐!"; $("exp").textContent = "";
  const html = filteredIdxs.map((di, k)=>{
    const q = data[di];
    const buttons = q.choices.map((c,i)=>`<button onclick="chooseAll(${k}, ${i})">${i+1}. ${c}</button>`).join("");
    return `<div class="item" id="qblock_${k}">
      <div class="meta">#${q.id} · ${q.subject} / ${q.unit}</div>
      <div style="font-weight:600;margin:6px 0">${q.question}</div>
      <div class="choices" id="choices_all_${k}">${buttons}</div>
      <p class="meta" id="exp_all_${k}" style="margin-top:6px"></p>
    </div>`;
  }).join("");
  $("choices").innerHTML = html;
}
function recordResult(q, ok, choiceIndex){
  attempts[q.id] = { lastState: ok?"correct":"wrong", lastChoice: choiceIndex };
  if(ok){ delete wrongSet[q.id]; correctSet[q.id] = true; }
  else { wrongSet[q.id] = true; delete correctSet[q.id]; }
  refreshNoteBadge();
  saveCloud();
}
window.chooseAll = (k, i)=>{
  const di = filteredIdxs[k]; const q = data[di];
  const choicesBox = document.getElementById("choices_all_"+k); if(!choicesBox) return;
  if(Array.from(choicesBox.children).some(b=>b.disabled)) return;
  Array.from(choicesBox.children).forEach((b,j)=>{ b.disabled=true; if(j===q.answerIndex) b.classList.add("correct"); if(j===i && i!==q.answerIndex) b.classList.add("wrong"); });
  const ok = (i===q.answerIndex);
document.getElementById("exp_all_"+k).innerHTML = (ok ? "정답! " : "오답. 정답은 " + (q.answerIndex+1) + "번. ") + (q.explanation ? q.explanation.replace(/\n/g, "<br>") : "");

  if(ok) correct++; else wrong++; $("good").textContent = correct; $("bad").textContent = wrong;
  recordResult(q, ok, i);
};
window.choose = (i)=>{
  const q = data[filteredIdxs[idx]];
  [...$("choices").children].forEach((b,j)=>{ b.disabled=true; if(j===q.answerIndex) b.classList.add("correct"); if(j===i && i!==q.answerIndex) b.classList.add("wrong"); });
  const ok = (i===q.answerIndex);
$("exp").innerHTML = (ok ? "정답! " : "오답. 정답은 " + (q.answerIndex+1) + "번. ") + (q.explanation ? q.explanation.replace(/\n/g, "<br>") : "");

  if(ok) correct++; else wrong++; $("good").textContent = correct; $("bad").textContent = wrong;
  recordResult(q, ok, i);
};

/* 리뷰 */
function renderReview(){
  const s = $("revSubject").value, u = $("revUnit").value, st = $("revState").value;
  const rows = data.filter(q=> (s==="(전체)"||q.subject===s) && (u==="(전체)"||q.unit===u))
    .map(q=>{ const att = attempts[q.id]; const state = att?.lastState || "-"; const my = att?.lastChoice!=null ? (q.choices[att.lastChoice]||"-") : "-"; const ans = q.choices[q.answerIndex]||"-"; return {q, state, my, ans}; })
    .filter(r=> st==="all" ? true : r.state===st);
  $("revBody").innerHTML = rows.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.q.subject}</td><td>${r.q.unit}</td><td>${r.q.question}</td><td>${r.my}</td><td>${r.ans}</td><td>${r.state}</td>
  </tr>`).join("");
}
function exportByState(state){
  const out = data.filter(q=>{ const st = attempts[q.id]?.lastState; return state==="all"? true : st===state; });
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = state+"_questions_recent.json"; a.click();
}
function exportSet(which){
  const ids = which==="wrong" ? wrongSet : correctSet;
  const out = data.filter(q=> !!ids[q.id]);
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = which+"_note_accumulated.json"; a.click();
}

/* CSV 파서 */
function parseCSV(text){
  const sep = text.includes("\t") ? "\t" : ","; 
  const rows=[]; let cur=[], field="", inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ field+='"'; i++; } 
        else { inQuotes=false; }
      } else { field += ch; }
    }else{
      if(ch === '"'){ inQuotes=true; }
      else if(ch === sep){ cur.push(field); field=""; }
      else if(ch === "\n"){ cur.push(field); rows.push(cur); cur=[]; field=""; }
      else if(ch !== "\r"){ field += ch; }
    }
  }
  cur.push(field); rows.push(cur);
  return rows.filter(r=> r.length>1 || (r[0] && r[0].trim()));
}

/* ======== 3) DOM 준비되면 한 번에 이벤트 연결 ======== */
document.addEventListener("DOMContentLoaded", ()=>{
  // 인증 버튼
  $("loginBtn").onclick = async () => {
    try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
    catch(e){ alert("로그인 실패: " + (e?.message || e)); }
  };
  $("logoutBtn").onclick = ()=> signOut(auth);

  // 탭
  $("tabBuild").onclick = ()=>show("build");
  $("tabQuiz").onclick  = ()=>{ show("quiz"); prepareFiltered(); startQuiz(); };
  $("tabReview").onclick= ()=>show("review");
  $("tabImport").onclick= ()=>show("import");



$("filterSubject").onchange = ()=> updateUnitOptions("filterSubject","filterUnit");
$("revSubject").onchange   = ()=> updateUnitOptions("revSubject","revUnit");
$("buildFilterSubject").onchange = ()=> updateUnitOptions("buildFilterSubject","buildFilterUnit");



  // 빌더
  $("clearBtn").onclick=()=>["subject","unit","question","c1","c2","c3","c4","c5","explain"].forEach(id=>$(id).value="");
  $("addBtn").onclick=()=>{
    if(!user){ alert("로그인 후 이용해줘!"); return; }
    const subject = $("subject").value.trim()||"미지정";
    const unit = $("unit").value.trim()||"일반";
    const question = $("question").value.trim();
    const choices = ["c1","c2","c3","c4","c5"].map(id=>($(id).value||"").trim()).filter(v=>v);
    const ai = parseInt($("answerIndex").value,10)-1;
    const explanation = $("explain").value.trim();
    if(!question || choices.length<2 || isNaN(ai) || ai<0 || ai>=choices.length){
      alert("문항/보기(2개 이상)/정답 번호를 확인해줘."); return;
    }
    data.push({ id: genId(), subject, unit, question, choices, answerIndex: ai, explanation });
    buildPrepareFiltered(); renderList(); refreshAllFilters();
    $("clearBtn").click();
    saveCloud();
  };

  $("saveBtn").onclick=()=>{
    const blob = new Blob([JSON.stringify({data,attempts,wrongSet,correctSet}, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cbt_backup.json";
    a.click();
  };
  $("loadBtn").onclick=()=>$("file").click();
  $("file").onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    f.text().then(t=>{
      try{
        const incoming = JSON.parse(t);
        const arr = Array.isArray(incoming) ? incoming : incoming.data;
        if(!Array.isArray(arr)) throw new Error("JSON 형식이 문항 배열이 아님");
        arr.forEach(q=>{ q.id = genId(); });
        data = data.concat(arr);
        buildPrepareFiltered(); renderList(); refreshAllFilters(); refreshNoteBadge();
        saveCloud();
        alert("불러오기 완료!");
      }catch(err){ alert("JSON 형식 오류: "+err.message); }
    });
  };

  $("startBtn").onclick=()=>{ if(data.length===0){ alert("문제가 없음!"); return; } prepareFiltered(); startQuiz(); show("quiz"); };
  $("backToBuild").onclick=()=>show("build");

  // 빌더 필터/선택/삭제
  $("buildApplyFilter").onclick = ()=>{ buildSelected.clear(); buildPrepareFiltered(); renderList(); };
  $("buildClearFilter").onclick = ()=>{
    if($("buildFilterSubject")) $("buildFilterSubject").selectedIndex = 0;
    updateUnitOptions("buildFilterSubject","buildFilterUnit");
    if($("buildFilterUnit")) $("buildFilterUnit").selectedIndex = 0;
    buildSelected.clear(); buildPrepareFiltered(); renderList();
  };
  $("buildSelectAll").onclick   = ()=>{ const checks=$("listBox").querySelectorAll(".sel"); checks.forEach(ch=>{ ch.checked = true; buildSelected.add(parseInt(ch.getAttribute("data-id"),10)); }); };
  $("buildSelectNone").onclick  = ()=>{ const checks=$("listBox").querySelectorAll(".sel"); checks.forEach(ch=>{ ch.checked = false; buildSelected.delete(parseInt(ch.getAttribute("data-id"),10)); }); };
  $("buildSelectInvert").onclick= ()=>{ const checks=$("listBox").querySelectorAll(".sel"); checks.forEach(ch=>{ const id=parseInt(ch.getAttribute("data-id"),10); const now=!ch.checked; ch.checked=now; if(now) buildSelected.add(id); else buildSelected.delete(id); }); };
  $("buildDeleteSelected").onclick = ()=>{
    const ids = Array.from(buildSelected);
    if(ids.length===0){ alert("선택된 문제가 없어!"); return; }
    if(!confirm(`${ids.length}문항을 삭제할까요? (되돌릴 수 없음)`)) return;
    const remove = new Set(ids);
    data = data.filter(q=>!remove.has(q.id));
    ids.forEach(id=>{ if(attempts[id]) delete attempts[id]; delete wrongSet[id]; delete correctSet[id]; });
    buildSelected.clear(); refreshAllFilters(); buildPrepareFiltered(); renderList(); refreshNoteBadge();
    saveCloud();
  };

  // 퀴즈 필터/버튼
  ["onlyWrong","onlyCorrect"].forEach(id=>{ const el=$(id); if(el){ el.onchange = ()=>{ prepareFiltered(); startQuiz(); }; }});
  $("applyFilter").onclick=()=>{ prepareFiltered(); startQuiz(); };
  $("clearFilter").onclick = () => {
    $("filterSubject").selectedIndex = 0; updateUnitOptions("filterSubject","filterUnit");
    $("filterUnit").selectedIndex = 0;
    if($("onlyWrong")) $("onlyWrong").checked = false;
    if($("onlyCorrect")) $("onlyCorrect").checked = false;
    prepareFiltered(); startQuiz();
  };
  $("prevBtn").onclick=()=>{ if(idx>0){ idx--; renderQuiz(); } };
  $("nextBtn").onclick=()=>{ const total=filteredIdxs.length; if(idx<total-1){ idx++; renderQuiz(); } else { alert(`끝! 정답 ${correct}, 오답 ${wrong}`); } };

  // 리뷰
  $("revApply").onclick=()=>renderReview();
  $("exportWrong").onclick=()=>exportByState("wrong");
  $("exportCorrect").onclick=()=>exportByState("correct");
  $("exportWrongSet").onclick=()=>exportSet("wrong");
  $("exportCorrectSet").onclick=()=>exportSet("correct");
  $("clearWrongSet").onclick=()=>{ if(confirm("오답노트를 모두 비울까요?")){ wrongSet={}; refreshNoteBadge(); saveCloud(); alert("오답노트 초기화 완료"); } };
  $("clearCorrectSet").onclick=()=>{ if(confirm("정답노트를 모두 비울까요?")){ correctSet={}; refreshNoteBadge(); saveCloud(); alert("정답노트 초기화 완료"); } };

  // 대량 가져오기 (3파일)
  $("runImport").onclick=async()=>{
    if(!user){ alert("로그인 후 이용해줘!"); return; }
    const fq = $("impQ").files[0], fa = $("impA").files[0], fe = $("impE").files[0];
    if(!fq || !fa){ alert("문제 파일과 정답 파일은 필수!"); return; }
    const [tq, ta, te] = await Promise.all([fq.text(), fa.text(), fe?fe.text():Promise.resolve("")]);
    const qLines = tq.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const aLines = ta.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const eLines = te.split(/\r?\n/).map(s=>s.trim());
    const N = Math.min(qLines.length, aLines.length);
    let added=0;
    for(let i=0;i<N;i++){
      const parts = qLines[i].split("|").map(s=>s.trim());
      const subject = parts[0]||"미지정";
      const unit = parts[1]||"일반";
      const question = parts[2]||"";
      const choices = parts.slice(3).filter(Boolean);
      const ansIdx = parseInt(aLines[i],10) - 1;
      const explanation = eLines[i]||"";
      if(!question || choices.length<2 || isNaN(ansIdx) || ansIdx<0 || ansIdx>=choices.length){ continue; }
      data.push({ id: genId(), subject, unit, question, choices, answerIndex: ansIdx, explanation });
      added++;
    }
    buildPrepareFiltered(); renderList(); refreshAllFilters(); saveCloud();
    alert(`가져오기 완료: ${added}문항 추가`);
  };

  // CSV 한 파일
  $("runCSV").onclick=async()=>{
    if(!user){ alert("로그인 후 이용해줘!"); return; }
    const f = $("impCSV").files[0]; if(!f){ alert("CSV 파일을 선택해줘!"); return; }
    const txt = await f.text(); const rows = parseCSV(txt); if(rows.length < 2){ alert("CSV에 데이터가 없어요."); return; }

    const header = rows[0].map(h=>h.trim()); const col = name => header.indexOf(name);
    const idxSub = col("과목"), idxUnit = col("단원"), idxQ = col("문제"),
          idxC1 = col("보기1"), idxC2 = col("보기2"), idxC3 = col("보기3"),
          idxC4 = col("보기4"), idxC5 = col("보기5"),
          idxAns = col("답"), idxExp = col("해설");

    const need = [idxSub, idxUnit, idxQ, idxC1, idxC2, idxAns];
    if(need.some(i=>i<0)){ alert("필수 헤더(과목, 단원, 문제, 보기1, 보기2, 답)가 필요해요."); return; }

    let added=0;
    let errors=[];
    for(let r=1; r<rows.length; r++){
      const row = rows[r]; 
      if(row.length===1 && !(row[0]||"").trim()) continue;

      const subject=(row[idxSub]||"미지정").trim(),
            unit=(row[idxUnit]||"일반").trim(),
            question=(row[idxQ]||"").trim();

      const choices=[idxC1,idxC2,idxC3,idxC4,idxC5]
        .filter(i=>i>=0)
        .map(i=>(row[i]||"").trim())
        .filter(Boolean);

      const ansIdx=parseInt((row[idxAns]||"").trim(),10)-1;
      const explanation=idxExp>=0?(row[idxExp]||"").trim():"";

      if(!question){ errors.push({line:r+1, reason:"문제 없음"}); continue; }
      if(choices.length<2){ errors.push({line:r+1, reason:"보기 2개 미만"}); continue; }
      if(isNaN(ansIdx)){ errors.push({line:r+1, reason:"정답 번호 없음/숫자 아님"}); continue; }
      if(ansIdx<0 || ansIdx>=choices.length){ errors.push({line:r+1, reason:"정답 번호 범위 오류"}); continue; }

      data.push({ id: genId(), subject, unit, question, choices, answerIndex: ansIdx, explanation });
      added++;
    }

    buildPrepareFiltered(); renderList(); refreshAllFilters(); saveCloud();

    let msg=`CSV 가져오기 완료: ${added}문항 추가`;
    if(errors.length){
      msg+=`\n오류 ${errors.length}건:\n`+errors.map(e=>`줄 ${e.line}: ${e.reason}`).join("\n");
    }
    alert(msg);
  };

  // 인증 상태 변화(화면 요소가 준비된 뒤에 연결)
  onAuthStateChanged(auth, async (u)=>{
    user = u || null;
    if(user){
      $("loginBtn").classList.add("hidden");
      $("logoutBtn").classList.remove("hidden");
      $("whoAmI").textContent = user.email || user.displayName || user.uid;
      await loadCloud();
      initAfterDataLoad();
    }else{
      $("loginBtn").classList.remove("hidden");
      $("logoutBtn").classList.add("hidden");
      $("whoAmI").textContent = "";
      disableAppUntilLogin(true);
    }
  });
});
</script>


</body>
</html>
